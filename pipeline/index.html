
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://digitalcommons.github.io/property-boundaries-service/pipeline/">
      
      
        <link rel="prev" href="../deployment/">
      
      
        <link rel="next" href="../testing/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>The Ownerships + INSPIRE updates pipeline - Property Boundaries Service Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2a3383ac.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#the-ownerships-inspire-updates-pipeline" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Property Boundaries Service Docs" class="md-header__button md-logo" aria-label="Property Boundaries Service Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Property Boundaries Service Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              The Ownerships + INSPIRE updates pipeline
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/DigitalCommons/property-boundaries-service" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    DigitalCommons/property-boundaries-service
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Property Boundaries Service Docs" class="md-nav__button md-logo" aria-label="Property Boundaries Service Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Property Boundaries Service Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/DigitalCommons/property-boundaries-service" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    DigitalCommons/property-boundaries-service
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Intro
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../database/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    The Database
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DCC servers
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    The Ownerships + INSPIRE updates pipeline
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    The Ownerships + INSPIRE updates pipeline
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview-of-the-data" class="md-nav__link">
    <span class="md-ellipsis">
      Overview of the data
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Overview of the data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-crux-of-the-issue" class="md-nav__link">
    <span class="md-ellipsis">
      The crux of the issue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#different-cases-of-data-changing" class="md-nav__link">
    <span class="md-ellipsis">
      Different cases of data changing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-big-limitation-leaseholds" class="md-nav__link">
    <span class="md-ellipsis">
      A big limitation: leaseholds
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stages-of-the-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Stages of the pipeline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-run-it" class="md-nav__link">
    <span class="md-ellipsis">
      How to run it
    </span>
  </a>
  
    <nav class="md-nav" aria-label="How to run it">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#manually" class="md-nav__link">
    <span class="md-ellipsis">
      Manually
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automatic-runs" class="md-nav__link">
    <span class="md-ellipsis">
      Automatic runs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#analysing-the-pipeline-output" class="md-nav__link">
    <span class="md-ellipsis">
      Analysing the pipeline output
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Testing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../todo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TODO
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview-of-the-data" class="md-nav__link">
    <span class="md-ellipsis">
      Overview of the data
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Overview of the data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-crux-of-the-issue" class="md-nav__link">
    <span class="md-ellipsis">
      The crux of the issue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#different-cases-of-data-changing" class="md-nav__link">
    <span class="md-ellipsis">
      Different cases of data changing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-big-limitation-leaseholds" class="md-nav__link">
    <span class="md-ellipsis">
      A big limitation: leaseholds
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stages-of-the-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Stages of the pipeline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-run-it" class="md-nav__link">
    <span class="md-ellipsis">
      How to run it
    </span>
  </a>
  
    <nav class="md-nav" aria-label="How to run it">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#manually" class="md-nav__link">
    <span class="md-ellipsis">
      Manually
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automatic-runs" class="md-nav__link">
    <span class="md-ellipsis">
      Automatic runs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#analysing-the-pipeline-output" class="md-nav__link">
    <span class="md-ellipsis">
      Analysing the pipeline output
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="the-ownerships-inspire-updates-pipeline">The Ownerships + INSPIRE updates pipeline<a class="headerlink" href="#the-ownerships-inspire-updates-pipeline" title="Permanent link">#</a></h1>
<p>The purpose of the Ownerships + INSPIRE pipeline is to retrieve new data from open source government
datasets and use it to update the data in our PBS database, which can then be served to Land Explorer.</p>
<p>Note that we currently only have property data for England and Wales.</p>
<p>All of the pipeline-related code lives in the <code>src/pipeline</code> directory.</p>
<h2 id="overview-of-the-data">Overview of the data<a class="headerlink" href="#overview-of-the-data" title="Permanent link">#</a></h2>
<p>We store data in 3 database tables:</p>
<ul>
<li><code>land_ownerships</code> -
  each row in this table links a 'title' (i.e. a title deed for a single property in the Land Registry)
  to a company that owns it. It includes the 'tenure' (leasehold or freehold), when the title was added to the Land Registry, and various details about the company.</li>
<li><code>land_ownership_polygons</code> -
  each row in this table gives the geometry of a land boundary for a registered property. It has a <code>poly_id</code> (a.k.a. INSPIRE ID) and possibly a <code>title_no</code> to link the property to on ownership in the above table.</li>
<li><code>unregistered_land</code> -
  each row has the geometry of a polygon boundary for a piece of unregistered land.</li>
</ul>
<p>The pipeline obtains data from these open source datasets:</p>
<ul>
<li>
<p>INSPIRE - a set of polygons, purely land boundaries of <strong>freehold</strong> properties (but maybe not a complete set?). Each has an INSPIRE ID. This data set does not link Title Number to these polygons. An updated full dataset is published each month, and there is no way
  to access historical data.</p>
</li>
<li>
<p>Land Reg UK Companies - A list of all UK companies that own property, linking a company to a Title Number.</p>
</li>
<li>
<p>Land Reg Overseas Companies - A list of overseas companies that own property, linking a company to a Title Number.</p>
</li>
</ul>
<p>In the past, we also used the following closed source dataset:</p>
<ul>
<li>National Polygon Service (closed source) - Boundaries for leaseholds <em>AND</em> freeholds, plus Title Numbers for <em>MOST</em> of these freeholds/leaseholds (the spec says all should have matched titles but some don’t seem to have them). A Title Number is unique to that property and <a href="https://www.brecher.co.uk/news/the-title-register-a-quick-explainer/">doesn't change between owners</a>. Also, <a href="https://blog.wheregeospatial.com/2019/02/07/land-registry-and-inspire-index-polygons-interview-andrew-trigg/">a single title may have multiple linked polygons</a> with separate poly_ids e.g. when garages are in blocks separate from housing.</li>
</ul>
<p><em>Note: We refer to poly_id and INSPIRE ID interchangeably because they are the same. The set of INSPIRE polygons is a subset of all polygons in the National Polygon Service, and they share the same ID in each dataset. See the dataset's <a href="https://use-land-property-data.service.gov.uk/datasets/nps/tech-spec/1">technical specification</a> for more info.</em></p>
<h3 id="the-crux-of-the-issue">The crux of the issue<a class="headerlink" href="#the-crux-of-the-issue" title="Permanent link">#</a></h3>
<p>We gained a copy of the National Polygon Service for evaluation purposes a few years back, but no
longer have access. This means there is no longer a way to reliably link Titles to INSPIRE boundary
polygons. The <strong>purpose of the pipeline</strong> is therefore to attempt to <strong>update ownership and boundary data,
whilst preserving the link between titles and polygons where possible.</strong></p>
<h3 id="different-cases-of-data-changing">Different cases of data changing<a class="headerlink" href="#different-cases-of-data-changing" title="Permanent link">#</a></h3>
<p>In order to achive the above purpose, we need to understand how &amp; why the data might change, so that
we can recognise these cases and know how to procede in our pipeline.</p>
<p>Here is a list of cases (W.I.P.) and what we do in the pipeline for each scenario:</p>
<ol>
<li>
<p>The ownership of a title changes in one of the company ownership datasets (UK or overseas)</p>
<ul>
<li>Since a Title Number is unique to that property and shouldn't change between owners, we can
  assume that any polygons linked to that title are now owned by the new company. So we just
  need to update the title in the <code>land_ownerships</code> table and make no changes to <code>land_ownership_polygons</code>.</li>
</ul>
</li>
<li>
<p>A freehold title is removed from the company ownership datasets</p>
<ul>
<li>If the title's linked INPSIRE polygon(s) have merged with an adjacent polygon, see case 7 below. Otherwise:</li>
<li>This indicates that the title has been sold to a private individual. If the title had linked
polygon(s) which are unchanged, we can keep the link to the title number. There's a chance it
will be sold to a company in the future, so more ownership info will be visible again. So remove
the title from the <code>land_ownerships</code> table and make no changes to <code>land_ownership_polygons</code>.</li>
</ul>
</li>
<li>
<p>A leasehold title is removed from the company ownership datasets</p>
<ul>
<li><em>EITHER</em> the title has been sold to a private individual, in which case we can keep the link
  between title number and polygon(s). So remove the title from the <code>land_ownerships</code> table and make no changes to <code>land_ownership_polygons</code>.</li>
<li><em>OR</em> the lease may have been closed by a <a href="https://hmlandregistry.blog.gov.uk/2024/03/27/amalgamation-or-merger-whats-the-difference/">merger</a> if the same company also owns the freehold. We don't have
enough info to tell if this happened, but may be able to use the <a href="https://use-land-property-data.service.gov.uk/datasets/leases/tech-spec">Registered Leases</a> or <a href="https://www.gov.uk/guidance/about-the-price-paid-data">Price Paid Data</a> datasets
in the future to help with this. For now, just assume it was the former scenario.</li>
</ul>
</li>
<li>
<p>An INSPIRE polygon's boundary changes very slightly</p>
<ul>
<li>This indicates that there has been a new survey by the local authority and any freehold title
will still be linked to that property. Or it also occured when we improved our coordinate
transformation when importing the INSPIRE data. So update the coordinates in <code>land_ownership_polygons</code>.</li>
<li>(<strong>TODO</strong>) Since INSPIRE doesn't include leasehold polygons, we should also alter any associated
leashold boundaries. This isn't implemented yet. We also need to fix the leashold boudaries that
were left using the old coordinate transformation.</li>
</ul>
</li>
<li>
<p>An INSPIRE polygon's boundary moves by a large distance</p>
<ul>
<li>This is unexpected, since usually a new INSPIRE ID would just be made. We should examine these
instances manually (<strong>TODO</strong>). If the polygon has an associated company-owned title, we can geocode the title's
address and check whether the new location matches.</li>
</ul>
</li>
<li>
<p>An INSPIRE polygon splits into two or more parts</p>
<ul>
<li>When freehold titles are split, the owner will usually be selling off a portion of the property
(otherwise it usually makes more sense for them to split into leaseholds). More info <a href="https://lawdit.co.uk/readingroom/splitting-your-propertys-freehold-title">here</a> and <a href="https://customerhelp.landregistry.gov.uk/forums/register-and-title-plan/f7bd9ec5-cc7c-ef11-a4e5-6045bdfc7a75">here</a>. The portion that they keep will retain the old Title Number
and the new segment of land will be assigned a new Title Number. So maybe when this happens, we
can check for new company-owned titles with the same or adjacent address and link them (<strong>TODO</strong>).</li>
</ul>
</li>
<li>
<p>Two or more INSPIRE polygons merge</p>
<ul>
<li>Freeholds can be <a href="https://hmlandregistry.blog.gov.uk/2024/03/27/amalgamation-or-merger-whats-the-difference/">amalgamated</a> if they're owned by the same proprietor. Usually, the largest property's Title Number will be chosen for the new amalgamated title - see section 14.7.1 of <a href="https://rosdev.atlassian.net/wiki/spaces/79RM/pages/76155396/L14+Amalgamation+and+Absorption+Guide">this guide</a>. We can try to cross-reference with the company-owned titles data to see if this is the case. If the titles were company-owned, we'll hopefully see
that all amalgamated titles apart from one are removed from the dataset, and that the old ones had the same proprietor (<strong>TODO</strong>).</li>
</ul>
</li>
</ol>
<h3 id="a-big-limitation-leaseholds">A big limitation: leaseholds<a class="headerlink" href="#a-big-limitation-leaseholds" title="Permanent link">#</a></h3>
<p>See https://github.com/DigitalCommons/property-boundaries-service/issues/26</p>
<h2 id="stages-of-the-pipeline">Stages of the pipeline<a class="headerlink" href="#stages-of-the-pipeline" title="Permanent link">#</a></h2>
<p>The main function that runs the pipeline is <a href="https://github.com/DigitalCommons/property-boundaries-service/blob/development/src/pipeline/run.ts" target="_blank"><code>runPipeline()</code> in
run.ts</a>.</p>
<p>It runs these tasks in sequential order:</p>
<ol>
<li>
<p><code>ownerships</code>: This task updates the <code>land_ownerships</code> table (see above), using the latest company
    ownership data. This stage is quite fast and non-destructive, since the government API provides all
    historical data since Nov 2017, so the new data is always written straight into the DB.</p>
</li>
<li>
<p><code>downloadInspire</code>: This task</p>
<ol>
<li>downloads the latest INSPIRE data</li>
<li>backs up this data to our Hetzner storage box</li>
<li>unzips the downloaded GML data then, using GDAL, transforms it to the standard EPSG:4326
   coordinate system and inserts all polygons into the <code>pending_inspire_polygons</code> DB table</li>
</ol>
</li>
<li>
<p><code>analyseInspire</code>: This task does the following steps:</p>
<ol>
<li>
<p>Loop one-by-one through <code>pending_inspire_polygons</code>. Check if the poly_id already exists in our
  <code>land_ownership_polygons</code> table.</p>
<ul>
<li>
<p>If so, we compare the old and new polys and try to classify a match. i.e. one of the
scenarios in the <a href="#different-cases-of-data-changing">above section</a>. In some cases, the
algorithm fails to classify the match, maybe because the polyon changed in an unexpected
way. You can see descriptions of the match types implemented so far in
<a href="https://github.com/DigitalCommons/property-boundaries-service/blob/development/src/pipeline/inspire/match.ts" target="_blank"><code>match.ts</code></a>.
Depending on how the match is classified, we mark pending polygons as 'accepted' or
'rejected', and maybe mark existing polygons to be deleted.</p>
</li>
<li>
<p>If the poly_id is new, we check that it's not overlapping with an existing polygon in our
DB. If it isn't, we mark the new poly as accepted. We have some rough 'amalgamation'
detection code to cover more cases but haven't implemented it yet.</p>
</li>
</ul>
<p><em>Note: The plan is to improve these algorithms over time, based on manual review of our pipeline's
results and research of different scenarios (in the above section). So it will eventually identify
and classify more scenarios, rather than just marking them as failed matches.</em></p>
</li>
<li>
<p>If the <code>updateBoundaries</code> pipeline option was set to true, clip the boundaries of all new or
   changed<code>pending_inspire_polygons</code> (registered freehold boundaries) from the
   <code>unregistered_land</code> table, write all accepted <code>pending_inspire_polygons</code> into
   <code>land_ownership_polygons</code> (overwriting existing geometry data) and delete all polygons listed
   in <code>pending_polygon_deletions</code>.</p>
</li>
</ol>
</li>
</ol>
<h2 id="how-to-run-it">How to run it<a class="headerlink" href="#how-to-run-it" title="Permanent link">#</a></h2>
<h3 id="manually">Manually<a class="headerlink" href="#manually" title="Permanent link">#</a></h3>
<p>The pipeline can be triggered by an API request like this:</p>
<pre><code>https://&lt;PBS URL&gt;/run-pipeline?secret=&lt;secret&gt;
</code></pre>
<p>The pipeline can be started with additional options (see <a href="https://github.com/DigitalCommons/property-boundaries-service/blob/development/src/pipeline/run.ts" target="_blank"><code>PipelineOptions</code> in
run.ts</a>
for details), e.g.:</p>
<pre><code>https://&lt;PBS URL&gt;/run-pipeline?secret=&lt;secret&gt;&amp;startAtTask=analyseInspire&amp;maxCouncils=5
</code></pre>
<p><em>Note: The new INSPIRE boundaries will remain in the <code>pending_inspire_polygons</code> table where they can be manually analysed (see below) and will not be written into the actual <code>land_ownership_polygons</code> table unless the <code>updateBoundaries</code> pipeline option is set to true.</em></p>
<h3 id="automatic-runs">Automatic runs<a class="headerlink" href="#automatic-runs" title="Permanent link">#</a></h3>
<p>At DCC, we have automatic scripts to hit the API described above, so that the pipeline runs automatically.</p>
<p>They are scheduled to run after a Borg backup of the production database has been completed, which
itself is scheduled to run on the 8th night of each month (to ensure it's after the month's INSPIRE
data has been published on the first Sunday of the month). To avoid getting into too many details that
are specific to DCC infrastructure, see <a href="https://github.com/DigitalCommons/technology-and-infrastructure/issues/116#issuecomment-2163420776" target="_blank">this GitHub comment</a> for more details, and <a href="../deployment/#dcc-servers">deployment.md</a> for a rough overview of our DCC deployment.</p>
<h2 id="analysing-the-pipeline-output">Analysing the pipeline output<a class="headerlink" href="#analysing-the-pipeline-output" title="Permanent link">#</a></h2>
<p>After the <code>updateOwnerships</code> task is complete, the new company ownership data should be visible in LX for all users.</p>
<p>After the <code>downloadOwnerships</code> task, a LX super user can see the pending INSPIRE polygons that have been downloaded in a separate, secret data layer.</p>
<p>After the <code>analyseInspire</code> task has been run, the pending INSPIRE polygons will be marked 'accepted' if the matching algorithm thinks they are ready to be inserted into the main <code>land_ownership_polygons</code> DB table (either as a new row, or updating the geometry of an existing row if it has the same <code>poly_id</code>). If a pending polygon has been marked as 'accepted', this will be visible in the secret data layer on LX as a
green boundary. Non-accepted polys will appear as yellow.</p>
<p>Further detailed output for the pipeline can be found in the <code>analysis</code> folder in the project's root folder. This output can help you manually investigate something further e.g. if you want to investigate a failed match:</p>
<ul>
<li>find the details in <code>failed-matches.json</code> and copy a lng-lat of a vertex</li>
<li>login to LX as a super user (to become a super user, update your record in MySQL on the server)</li>
<li>enable the Pending Polygons data layer</li>
<li>search for the lng-lat in the LX search bar, then click on the properties in view to find and the polygon(s) involved</li>
</ul>
<p>Once you are satisfied that the <code>analyseInspire</code> task has marked the correct polygons as 'accepted', you can trigger the following API request to write them into the main DB table:</p>
<pre><code>https://&lt;PBS URL&gt;/run-pipeline?secret=&lt;secret&gt;&amp;resume=true&amp;updateBoundaries=true
</code></pre>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>